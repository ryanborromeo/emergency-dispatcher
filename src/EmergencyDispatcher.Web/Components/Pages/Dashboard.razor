@page "/dashboard"
@attribute [Authorize]
@rendermode InteractiveServer
@inject ICaseService CaseService
@inject NavigationManager Navigation

<PageTitle>Dashboard - Emergency Dispatch</PageTitle>

<MudGrid>
    <MudItem xs="12" Class="d-flex align-center justify-space-between">
        <div class="d-flex align-center">
            <MudText Typo="Typo.h4" Class="mr-3">Active Cases</MudText>
            <MudChip T="string" Color="Color.Error" Size="Size.Small">@_cases.Count</MudChip>
        </div>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Add"
                   Href="/cases/new">
            New Case
        </MudButton>
    </MudItem>

    <MudItem xs="12">
        <MudChipSet T="string" SelectionMode="SelectionMode.SingleSelection" SelectedValueChanged="OnFilterChanged">
            <MudChip T="string" Text="All" Value="@("All")" Default="true" Color="Color.Default" Variant="Variant.Outlined" />
            <MudChip T="string" Text="Open" Value="@("Open")" Color="Color.Warning" Variant="Variant.Outlined" />
            <MudChip T="string" Text="Notified" Value="@("Notified")" Color="Color.Info" Variant="Variant.Outlined" />
            <MudChip T="string" Text="En Route" Value="@("EnRoute")" Color="Color.Primary" Variant="Variant.Outlined" />
            <MudChip T="string" Text="Arrived" Value="@("Arrived")" Color="Color.Success" Variant="Variant.Outlined" />
        </MudChipSet>
    </MudItem>

    @if (_loading)
    {
        <MudItem xs="12" Class="d-flex justify-center pa-8">
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
        </MudItem>
    }
    else if (_cases.Count == 0)
    {
        <MudItem xs="12">
            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                No active cases. Click "New Case" to create one.
            </MudAlert>
        </MudItem>
    }
    else
    {
        @foreach (var c in _cases)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="3" Class="cursor-pointer case-card" @onclick="() => NavigateToCase(c.Id)">
                    <MudCardContent>
                        <div class="d-flex justify-space-between align-center mb-2">
                            <MudText Typo="Typo.h6">@c.PatientName</MudText>
                            <MudChip T="string" Size="Size.Small" Color="GetStatusColor(c.Status)">
                                @FormatStatus(c.Status)
                            </MudChip>
                        </div>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-1">
                            @c.EmergencyType
                        </MudText>
                        @if (c.Hospital != null)
                        {
                            <MudText Typo="Typo.caption">
                                <MudIcon Icon="@Icons.Material.Filled.LocalHospital" Size="Size.Small" Class="mr-1" />
                                @c.Hospital.Name
                            </MudText>
                        }
                        <div class="d-flex justify-space-between mt-2">
                            @if (c.EstimatedEta.HasValue)
                            {
                                <MudText Typo="Typo.caption">
                                    ETA: @c.EstimatedEta min
                                </MudText>
                            }
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @Humanizer.DateHumanizeExtensions.Humanize(c.CreatedAt)
                            </MudText>
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }
    }
</MudGrid>

@code {
    private List<Case> _cases = [];
    private bool _loading = true;
    private CaseStatus? _currentFilter;

    protected override async Task OnInitializedAsync()
    {
        await LoadCases();
    }

    private async Task LoadCases()
    {
        _loading = true;
        _cases = await CaseService.GetActiveCasesAsync(_currentFilter);
        _loading = false;
    }

    private async Task OnFilterChanged(string? value)
    {
        _currentFilter = value switch
        {
            "Open" => CaseStatus.Open,
            "Notified" => CaseStatus.Notified,
            "EnRoute" => CaseStatus.EnRoute,
            "Arrived" => CaseStatus.Arrived,
            _ => null
        };
        await LoadCases();
    }

    private void NavigateToCase(int id) => Navigation.NavigateTo($"/cases/{id}");

    private static Color GetStatusColor(CaseStatus status) => status switch
    {
        CaseStatus.Open => Color.Warning,
        CaseStatus.Notified => Color.Info,
        CaseStatus.EnRoute => Color.Primary,
        CaseStatus.Arrived => Color.Success,
        CaseStatus.Closed => Color.Default,
        _ => Color.Default
    };

    private static string FormatStatus(CaseStatus status) => status switch
    {
        CaseStatus.EnRoute => "En Route",
        _ => status.ToString()
    };
}
